// Check if formula calculation works after explicit recalc
System.debug('=== TESTING FORMULA RECALCULATION ===\n');

// Get one record with BTW = 0
Lead_Product__c testRecord = [
    SELECT Id, Product__r.ProductCode, Product__r.BTW__c,
           Aantal__c, Verkoopprijs__c, Totale_Prijs__c, 
           Korting_bedrag__c, Totaal__c, 
           BTW_Bedrag__c, Totaal_incl_BTW__c
    FROM Lead_Product__c
    WHERE CreatedDate = TODAY
      AND BTW_Bedrag__c = 0
    LIMIT 1
];

System.debug('ðŸ“Š BEFORE UPDATE:');
System.debug('  Product: ' + testRecord.Product__r.ProductCode);
System.debug('  Product__r.BTW__c: ' + testRecord.Product__r.BTW__c + '%');
System.debug('  Totale_Prijs__c: â‚¬' + testRecord.Totale_Prijs__c);
System.debug('  Totaal__c: â‚¬' + testRecord.Totaal__c);
System.debug('  BTW_Bedrag__c: â‚¬' + testRecord.BTW_Bedrag__c);
System.debug('  Totaal_incl_BTW__c: â‚¬' + testRecord.Totaal_incl_BTW__c);

// Touch the record to force formula recalculation
System.debug('\nðŸ”„ Updating record to trigger formula recalc...');
testRecord.Aantal__c = testRecord.Aantal__c; // No change, just touch
update testRecord;

// Re-query to see if formula updated
testRecord = [
    SELECT Id, Product__r.ProductCode, Product__r.BTW__c,
           Totaal__c, BTW_Bedrag__c, Totaal_incl_BTW__c
    FROM Lead_Product__c
    WHERE Id = :testRecord.Id
];

System.debug('\nðŸ“Š AFTER UPDATE:');
System.debug('  Totaal__c: â‚¬' + testRecord.Totaal__c);
System.debug('  BTW_Bedrag__c: â‚¬' + testRecord.BTW_Bedrag__c);
System.debug('  Totaal_incl_BTW__c: â‚¬' + testRecord.Totaal_incl_BTW__c);

if (testRecord.BTW_Bedrag__c > 0) {
    System.debug('\nâœ… SUCCESS: BTW formula now works after update!');
    System.debug('   â†’ Formula depends on fields that weren\'t set initially');
} else {
    System.debug('\nâŒ STILL BROKEN: BTW formula still returns 0');
    System.debug('   â†’ Formula itself might be incorrectly configured');
}

System.debug('\n=== CHECKING FORMULA SYNTAX ===');
System.debug('Expected formula for BTW_Bedrag__c:');
System.debug('  Totaal__c * (VALUE(Product__r.BTW__c) / 100)');
System.debug('');
System.debug('Expected formula for Totaal__c:');
System.debug('  Totale_Prijs__c - Korting_bedrag__c');
System.debug('  OR');
System.debug('  IF(ISBLANK(Korting_bedrag__c), Totale_Prijs__c, Totale_Prijs__c - Korting_bedrag__c)');
System.debug('');
System.debug('âš ï¸  If Product__r.BTW__c is a String field (as we discovered),');
System.debug('   the formula MUST use VALUE() to convert to number!');
System.debug('');
System.debug('Check in Setup > Object Manager > Lead_Product__c > Fields > BTW_Bedrag__c');
System.debug('View the actual formula and compare with expected formula above.');

System.debug('\n=== END TEST ===');
