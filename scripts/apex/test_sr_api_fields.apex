// Test SR segment API fields
// Purpose: Verify new Material_Type__c, Photo_Required__c, etc. are returned by PriceCalculationApi

System.debug('üß™ Testing SR segment API fields...');
System.debug('‚îÄ'.repeat(80));

// Create test request for SR segment
PriceCalculationApi.PriceRequest req = new PriceCalculationApi.PriceRequest();
req.postcode = '1012AB';
req.segment = 'SR';
req.siteId = 'CincoCleaning';
req.products = null; // Request catalog, not price calculation

// Simulate API call
RestRequest restReq = new RestRequest();
RestResponse restResp = new RestResponse();
RestContext.request = restReq;
RestContext.response = restResp;
restReq.requestBody = Blob.valueOf(JSON.serialize(req));

System.debug('üìû Calling PriceCalculationApi.calculatePrice() for SR segment...');
PriceCalculationApi.PriceResponse response = PriceCalculationApi.calculatePrice();

System.debug('‚îÄ'.repeat(80));
System.debug('‚úÖ API Response received');
System.debug('üìä Success: ' + response.success);
System.debug('üõçÔ∏è  Available Products: ' + response.availableProducts.size());

// Inspect SR products for new fields
Integer srProductCount = 0;
for (PriceCalculationApi.ResponseProduct product : response.availableProducts) {
    if (product.segment == 'SR') {
        srProductCount++;
        System.debug('‚îÄ'.repeat(80));
        System.debug('ü™ë SR Product: ' + product.productCode + ' - ' + product.productNaam);
        System.debug('   ‚îú‚îÄ Primary: ' + product.isPrimary);
        System.debug('   ‚îú‚îÄ Base Price: ‚Ç¨' + product.basePrice);
        System.debug('   ‚îú‚îÄ Material Type: ' + product.materialType);
        System.debug('   ‚îú‚îÄ Photo Required: ' + product.photoRequired);
        System.debug('   ‚îú‚îÄ Photo Min Count: ' + product.photoMinCount);
        System.debug('   ‚îú‚îÄ Photo Instructions: ' + (product.photoInstructions != null ? product.photoInstructions.substring(0, Math.min(50, product.photoInstructions.length())) + '...' : 'null'));
        System.debug('   ‚îî‚îÄ Furniture Type: ' + product.furnitureType);
        
        // Validate critical fields
        if (product.productCode.startsWith('SR-PRIM-MEUBEL')) {
            // Meubel products should have material type and photo requirements
            if (product.materialType == null) {
                System.debug('   ‚ö†Ô∏è  WARNING: materialType is null for meubel product');
            }
            if (!product.photoRequired) {
                System.debug('   ‚ö†Ô∏è  WARNING: photoRequired is false for meubel product (expected true)');
            }
            if (product.photoMinCount < 2) {
                System.debug('   ‚ö†Ô∏è  WARNING: photoMinCount is ' + product.photoMinCount + ' (expected >= 2)');
            }
        } else if (product.productCode.startsWith('SR-PRIM-TAPIJT')) {
            // Tapijt products should NOT require photos
            if (product.photoRequired) {
                System.debug('   ‚ö†Ô∏è  WARNING: photoRequired is true for tapijt product (expected false)');
            }
        }
    }
}

System.debug('‚îÄ'.repeat(80));
System.debug('üìà Summary:');
System.debug('   ‚îú‚îÄ Total SR Products: ' + srProductCount);
System.debug('   ‚îú‚îÄ Expected Products: 3 primaries (MEUBEL-STOF, MEUBEL-LEER, TAPIJT) + 6 extras');
System.debug('   ‚îî‚îÄ Bundle Discounts: ' + (response.bundleDiscounts != null ? response.bundleDiscounts.size() : 0));

// Check bundle discounts for SR segment
if (response.bundleDiscounts != null) {
    for (PriceCalculationApi.BundleDiscountRule rule : response.bundleDiscounts) {
        System.debug('   üéÅ ' + rule.label + ' (' + rule.segment + ')');
    }
}

System.debug('‚îÄ'.repeat(80));
System.debug('‚úÖ SR API Field Test Complete');
