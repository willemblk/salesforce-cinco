// ===================================================================
// BTW FIX VERIFICATION - Test dat BTW__c nu 21 is (niet 0.21)
// ===================================================================

System.debug('=== ðŸ§ª BTW FIX VERIFICATION (21 vs 0.21) ===\n');

Id leadId = '00Q9X00003GfrTpUAJ';

// STAP 1: Check huidige staat
List<Lead_Product__c> leadProducts = [
    SELECT Id, Name, Product__r.ProductCode, Product__r.BTW__c,
           BTW__c, Totale_Prijs__c, BTW_Bedrag__c, Totaal_incl_BTW__c,
           Aantal__c, Lengte_cm__c, Breedte_cm__c, Diameter_cm__c, 
           Oppervlakte_m__c, Gerelateerd_Product__c, Lead__c
    FROM Lead_Product__c 
    WHERE Lead__c = :leadId
];

System.debug('ðŸ“¦ Found ' + leadProducts.size() + ' Lead_Product__c records\n');

System.debug('BEFORE REPRICING:');
for (Lead_Product__c lp : leadProducts) {
    System.debug('   ' + lp.Product__r.ProductCode);
    System.debug('      Product2.BTW__c (source): ' + lp.Product__r.BTW__c);
    System.debug('      Lead_Product__c.BTW__c: ' + lp.BTW__c + ' â† Should be 21');
    System.debug('      BTW_Bedrag__c: â‚¬' + lp.BTW_Bedrag__c);
    System.debug('      Totaal_incl_BTW__c: â‚¬' + lp.Totaal_incl_BTW__c);
    System.debug('');
}

// STAP 2: Trigger repricing
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
System.debug('ðŸ”„ Calling PricingService.reprice()...');
System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

try {
    PricingService.reprice(leadProducts);
    System.debug('âœ… PricingService.reprice() completed');
    
    // Update to database
    update leadProducts;
    System.debug('âœ… Database update completed\n');
    
    // Re-query to see results
    leadProducts = [
        SELECT Id, Name, Product__r.ProductCode, 
               BTW__c, Totale_Prijs__c, BTW_Bedrag__c, Totaal_incl_BTW__c
        FROM Lead_Product__c 
        WHERE Lead__c = :leadId
    ];
    
    System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    System.debug('ðŸ“Š AFTER REPRICING:');
    System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
    Boolean allCorrect = true;
    
    for (Lead_Product__c lp : leadProducts) {
        System.debug('   ' + lp.Product__r.ProductCode);
        System.debug('      BTW__c: ' + lp.BTW__c);
        System.debug('      BTW_Bedrag__c: â‚¬' + lp.BTW_Bedrag__c);
        System.debug('      Totaal_incl_BTW__c: â‚¬' + lp.Totaal_incl_BTW__c);
        
        // Verify BTW__c is 21 (not 0.21 or 0)
        if (lp.BTW__c == 21) {
            System.debug('      âœ… SUCCESS: BTW__c = 21');
        } else if (lp.BTW__c == 0.21) {
            System.debug('      âš ï¸  OLD VALUE: BTW__c = 0.21 (should be 21)');
            allCorrect = false;
        } else if (lp.BTW__c == null || lp.BTW__c == 0) {
            System.debug('      âŒ FAIL: BTW__c is null or 0');
            allCorrect = false;
        } else {
            System.debug('      âš ï¸  UNEXPECTED: BTW__c = ' + lp.BTW__c);
            allCorrect = false;
        }
        
        // Verify BTW_Bedrag__c is calculated
        if (lp.BTW_Bedrag__c != null && lp.BTW_Bedrag__c > 0) {
            Decimal expectedBTW = lp.Totale_Prijs__c * 0.21; // 21%
            System.debug('      Expected BTW_Bedrag__c: â‚¬' + expectedBTW.setScale(2));
            
            if (Math.abs(lp.BTW_Bedrag__c - expectedBTW) < 0.01) {
                System.debug('      âœ… BTW_Bedrag__c is correct!');
            } else {
                System.debug('      âš ï¸  BTW_Bedrag__c mismatch (diff: â‚¬' + 
                           Math.abs(lp.BTW_Bedrag__c - expectedBTW).setScale(2) + ')');
            }
        } else {
            System.debug('      âŒ BTW_Bedrag__c is null or 0');
            allCorrect = false;
        }
        
        System.debug('');
    }
    
    System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    if (allCorrect) {
        System.debug('ðŸŽ‰ SUCCESS: All BTW fields are correct!');
    } else {
        System.debug('âš ï¸  Some fields need attention');
    }
    System.debug('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
} catch (Exception e) {
    System.debug('âŒ ERROR: ' + e.getMessage());
    System.debug('Stack: ' + e.getStackTraceString());
}

System.debug('\n=== ðŸ VERIFICATION COMPLETE ===');
